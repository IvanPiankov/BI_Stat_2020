---
title: "Второй_учебный_проект"
author: 
date: "30 11 2020"
output:
    html_document:
      toc: true
      toc_depth: 3
      toc_float: true
      number_section: true
---
# Подгружаем необходимые библиотеки

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(ggplot2)
require(plyr)
require(dplyr)
require(data.table)
require(data.table)
require(grid)
require(gridExtra)
require(cowplot)
require(GGally)
require(car)
require(PerformanceAnalytics)
require(MASS)
require(caTools)
```


# EDA

На первом шаге необходимо проверить количество "NA" если они есть. 
```{r library, echo=TRUE, warning=FALSE}
df = Boston
data(Boston)
sum(is.na(df))
str(df)
```

NA нет приступим к базовому анализу.

```{r function for read files}
summary(df)
```

Как мы можем увидить в переменных «crim», «zn», «rm» и «black» можно заметить разницу между их медианной и средним значением, что вероятнее всего может указывать на большое количество выбросов.Так как в задании сказано, что необходимо построить полную модель, мы не будем удалять выбросы и просто учтем, что они есть в данных переменных. 


Посчитаем корреляцию и если есть посмотрим на коллениарность между признаками.

```{r read}
chart.Correlation(df, histogram=TRUE, pch=19)
```

Мы наблюдаем позитивную корреляцию между переменными "rad" и "tax". И наблюдаем негативную корреляцию между "dis" и "age", а также "dis" и "nox".
Таким образом мы можем сказать, что в наших данных пресутствует мультиколлениарность, и это может привести к опеределенным проблемам при построении модели.
Как мы видим переменная "chas" является факторной переменной переведем её в фактор:

```{r str}
df$chas <- as.factor(df$chas)
```

В последнем шаге перед построением модели, мы должны посмотреть расперделение "medv". Поскольку, если она не нормльно распределена, то строит модель мы не сможем.

```{r EDA analysis}
qplot(x=medv,data=df,geom='histogram')

```

Да, действительно распределение не нормально, попробуем преобразовать данные путем нормализации

```{r Sex, warning=FALSE}
qplot(x=log(medv),data=df,geom='histogram')
```

Теперь наши данные отдаленно похожи на нормальное распределение

# Обязательная часть
## Задание № 1. Построение полной модели

```{r model}
model1 = lm(log(medv)~., data= df)
summary(model1)
```

Для нашей полной модели:
  R-squared = 0.7841
  F-statistic = 142.1
Таким образом можно сказать, что полная модель объесняет всего 78% изменчивости.
Наибольшим по модулю коэффициентом обладает переменная "lstat"

## Задание №2. Диагностика модели

```{r}
plot(model1)

```

Как видно из графиков Residuals vs Fitted присутствует не ленейная взаимосвязьмежду "medv" и предикторами. Также график QQ также далек от нормального, что говорит о ненормальности распределения остатоков, но это мы посмотрим далее.
Проверим нашу модель на мультиколлениарность:

```{r}
vif(model1)
```

Как мы видим наиболее большие показатели показывают переменные "rad" и "tax". Для дольнейшей модели, нам необходимо это будет учесть, для оптимизации модели
Далее необходиом определить нормальность распределения остатков:

```{r}
plot(model1$residuals)
abline(h=0,col='red')
```

Как можно видеть из графика остатки распределены ненормально в связи с этим, данной модели мы не можем доверять.

Проверим на выбросы нашу модель 

```{r}
outlierTest(model1)
```

Мы обнаружили 4 выброса, мы должны иметь это ввиду при дальнейшей работе с моделью

## Задание №3 Постройте график предсказаний стоимости от переменной, которая обладает наибольшим по модулю коэффициентом.
Построем модель с наиболее значимым предиктором.

```{r}
model_height <- lm(medv ~ as.numeric(lstat), data = df)
```

Построеим на предложенной модели предсказания, для построения грфика

```{r}
set.seed(154)
split <- sample.split(df,SplitRatio = 0.75) 
train <- subset(df,split==TRUE)
test_data<- subset(df,split==FALSE)
test_data$predicted.medv <- predict(model_height,test_data)

plot_1 <- ggplot(test_data, aes(medv,predicted.medv)) + 
  geom_point(alpha = 0.3)+
  stat_smooth(aes(fill = "blue"))+
  xlab("Средняя стоимость домов занятых владельцами (medv)")+
  ylab("Предсказанные значения")

plot_1
```

Подводя итог по обязательной части задания мы получили модель, которой не очень то следует доверять поскольку в ней, как говорилось ранее пристутвует мультиколлениарность, ненормальность распределения остатков. В свзяи с этим мы можем сделать вывод, что необходимо в дальнейшем оптимизировать данную модель. 

# Дополнительное задание

Как нами было показоно нами ранее присутствуют предикторы, которые значимо могут влиять на модель и мы можем их исключить.
Но, нам также следует использовать AIC для отбора оптимальной модели, сделаем это:

```{r}
step <- stepAIC(model1,direction = 'both')
step$anova
```

И так как мы видим, мы можем исключить из данной модели переменне "age" и "indus"
Удалим их и построим новую модель:

```{r}
new_model <- lm(log(medv) ~ crim + zn + chas + nox + rm + dis + rad + tax + ptratio + black + lstat,data=df)
summary(new_model)
```

Нам удалось незначимо увеличить R-squared. Проверим модель на мультиколлениарность. Строить графики в данном случае не имеет смысла, ведь мы совершенно не значимо увеличили R-squared.

```{r}
vif(new_model)
```

Мы видим, что по переменным "rad" и "tax" значение vif большое, попытаемся удалить их из модели и посмотреть, что произойдет тогда. 

```{r}
new_model2 <- lm(log(medv) ~ crim + zn + chas + nox + rm + dis + ptratio + black + lstat,data=df)
summary(new_model)
```

Как мы видим значение R-squared уменьшилось, попробуем посмотреть на выбросы и удалить их.

```{r}
outlierTest(new_model2)
df2 <- df[-c(372,413,373,369),,drop=T]
row.names(df2)=1:nrow(df2)
new_model3 = lm(log(medv) ~ crim + zn + chas + nox + rm + dis + ptratio + black + lstat,data=df2)
summary(new_model3)
```

При удалении выбросов нам удалось увеличить значение R-squared, теперь попробуем проверить данную модель через AIC и посмотреть на остатки.

```{r}
step1 <- stepAIC(new_model3,direction = 'both')
step1$anova
```

Как мы видим, мы можем удалить переменную "zn". Давайте так и сделаем.

```{r}
new_model4 = lm(log(medv) ~ crim + chas + nox + rm + dis + ptratio + black + lstat,data=df2)
summary(new_model4)
```

Построим графики и найдем выбросы, если они есть:

```{r}
outlierTest(new_model4)
df3 <- df2[-c(372,399),,drop=T]
row.names(df3)=1:nrow(df3)
new_model5 = lm(log(medv) ~ crim + chas + nox + rm + dis + ptratio + black + lstat,data=df3)
summary(new_model5)
```

Строим графики

```{r}
plot(new_model5$residuals)
abline(h=0,col='red')

par(mfrow=c(2,2))
plot(new_model5)

```

Остатки как и в первый раз распределены не нормально, но скорее всего с этим мы сделать ничего не сможем. 

# Заключение: 

Нам удалось получить модель, которая объесняет 81 процент изменчивости наши данных. Стоит отметить, что это не идельная модель, которая содержит множество не достатков в том числе ненормальное распределение остатков, но можно сказать, что это наилучший вариант модели рассмотренный нами. Не стоит забывать, что переменная medv была прологарифмирована в связи с этим, интропретация модели будет следующей: Изменение переменной medv в %-ах при росте предиктора на 1.

# Заключение дла заказчика:

Для роста стоимости участков необходимо сконцентрироваться на следующих показателях, уровню преступности на душу населения, наличие речки в непосредственной близи с продаваемым участком, концентрации оксида азота, количестве комнат в доме, доступности центров занятости, соотношение учников и учителей по району, количеству проживаемых чернокожих на районе, а также на статусе населения проживающего в данном районе. Наиболее значимо на стоимость дома будет влиять следующие параметры: наличие или отсутствие речки вблези дом, уровень преступности на районе и концентрация оксида азота.